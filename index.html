<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DDMRP Buffer Calculator (MVP)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="description" content="Enter a few numbers to instantly size DDMRP buffers and see Top of Red/Yellow/Green.">
  <style>
    :root { color-scheme: light dark; }
    .number-input { appearance: textfield; background-color: #f8f9fa; }
    .number-input::-webkit-outer-spin-button,
    .number-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .tooltip {
      position: fixed; z-index: 50; pointer-events: none;
      transform: translate(-50%, -120%); white-space: nowrap;
      padding: 0.25rem 0.5rem; font-size: 0.75rem;
      border-radius: 0.375rem; background: rgba(17, 24, 39, 0.95);
      color: white; box-shadow: 0 4px 10px rgba(0,0,0,.2);
      display: none; transition: opacity 0.1s ease-in-out;
    }
    .subformula {
      margin-left: 1rem;
      padding-left: 0.75rem;
      border-left: 2px solid #e5e7eb;
      font-size: 0.9em;
      color: #4b5563;
    }
    .chev { transition: transform .15s ease; }
    .chev.open { transform: rotate(90deg); }
    .calc-line { font-variant-numeric: tabular-nums; }
  </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-900 antialiased">
  <header class="bg-white border-b border-gray-200">
    <div class="mx-auto max-w-4xl px-4 py-6 flex items-center justify-between">
      <h1 class="text-2xl font-semibold">DDMRP Buffer Calculator</h1>
      <div class="text-sm text-gray-500">MVP · runs entirely in your browser</div>
    </div>
  </header>

  <main class="mx-auto max-w-4xl px-4 py-6 grid gap-6">
    <section class="bg-white rounded-2xl border border-gray-200 p-5">
      <p class="text-gray-700 leading-relaxed">
        Enter a few inputs to instantly calculate <span class="font-medium">Red / Yellow / Green</span> buffer zones and 
        Top of Levels. This tool runs entirely in your browser — 
        <span class="font-medium">your entries never leave your device</span>.
      </p>
    </section>

    <section class="bg-white rounded-2xl border border-gray-200 p-5">
      <h2 class="text-lg font-semibold mb-4">Inputs</h2>

      <!-- Required Fields -->
      <div class="grid gap-4 sm:grid-cols-2">
        <label class="block">
          <span class="text-sm text-gray-600">Average Daily Usage (ADU)<span class="text-rose-600">*</span></span>
          <input id="adu" type="number" min="0" step="any"
                 class="number-input mt-1 w-full rounded-xl border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                 placeholder="e.g., 25" value="25" />
        </label>

        <label class="block">
          <span class="text-sm text-gray-600">Supplier Lead Time (days)<span class="text-rose-600">*</span></span>
          <input id="dlt" type="number" min="0" step="any"
                 class="number-input mt-1 w-full rounded-xl border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                 placeholder="e.g., 10" value="10" />
        </label>

        <!-- Variability and LTF Row -->
        <div class="sm:col-span-2 grid sm:grid-cols-2 gap-4">
          <label class="block">
            <span class="text-sm text-gray-600">Variability Factor (0–1)<span class="text-rose-600">*</span></span>
            <div class="mt-1 flex items-center gap-3">
              <input id="varFactor" type="number" min="0" max="1" step="0.05"
                     class="number-input w-full rounded-xl border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                     placeholder="e.g., 0.30" value="0.30" />
            </div>
            <div class="mt-2 flex flex-wrap gap-2 text-xs">
              <button type="button" class="rounded-full border px-3 py-1 hover:bg-gray-50" onclick="setVar(0.15)">Low 0.15</button>
              <button type="button" class="rounded-full border px-3 py-1 hover:bg-gray-50" onclick="setVar(0.30)">Med 0.30</button>
              <button type="button" class="rounded-full border px-3 py-1 hover:bg-gray-50" onclick="setVar(0.50)">High 0.50</button>
              <button type="button" class="rounded-full border px-3 py-1 hover:bg-gray-50" onclick="setVar(0.70)">V-High 0.70</button>
            </div>
          </label>

          <div class="flex flex-col justify-end">
            <div class="text-sm text-gray-600">Lead Time Factor (auto)</div>
            <div id="ltFactorDisplay" class="text-2xl font-semibold">—</div>
            <div class="text-xs text-gray-500 mt-1">Derived from supplier lead time.</div>
          </div>
        </div>
      </div>

      <!-- Optional Fields (Collapsible) -->
      <details class="mt-6 rounded-xl border border-gray-200 open:bg-gray-50">
        <summary class="cursor-pointer font-semibold px-3 py-2">Optional Inputs</summary>
        <div class="px-3 pb-4 pt-2">
          <div class="grid gap-4 sm:grid-cols-2">
            <label class="block">
              <span class="text-sm text-gray-600">Minimum Order Quantity (MOQ), units</span>
              <input id="moq" type="number" min="0" step="any"
                     class="number-input mt-1 w-full rounded-xl border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                     placeholder="Leave blank if none" />
            </label>

            <label class="block">
              <span class="text-sm text-gray-600">Imposed Order Frequency, days</span>
              <input id="orderCycle" type="number" min="0" step="any"
                     class="number-input mt-1 w-full rounded-xl border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                     placeholder="e.g., 7 (orders every 7 days)" />
              <div class="mt-1 text-xs text-gray-500">
                If you only place orders every N days, Green must at least cover that cycle (ADU × N).
              </div>
            </label>
          </div>
        </div>
      </details>

      <details class="mt-4 rounded-2xl border border-gray-200 p-3 open:bg-gray-50">
        <summary class="cursor-pointer font-medium">Formula notes (MVP)</summary>
        <ul class="mt-2 list-none pl-0 text-sm text-gray-700 space-y-2">

          <!-- GREEN -->
          <li><strong class="text-green-600">Green (Replenishment Zone)</strong></li>
          <li class="subformula">Green Base = ADU × Lead Time × Lead Time Factor</li>
          <li class="subformula">Green = max(Green Base, MOQ (if any), ADU × Order Frequency (if any))</li>
          <li class="subformula">Top of Green (Replenishment Target) = Red + Yellow + Green</li>

          <!-- YELLOW -->
          <li class="mt-2"><strong class="text-yellow-600">Yellow (Demand Zone)</strong></li>
          <li class="subformula">Yellow = ADU × Lead Time</li>
          <li class="subformula">Top of Yellow (Replenishment Trigger) = Red + Yellow</li>

          <!-- RED -->
          <li class="mt-2"><strong class="text-red-600">Red (Safety Zone)</strong></li>
          <li class="subformula">Total Red (Safety Zone) = Red Base + Red Safety</li>
          <li class="subformula">Red Base = ADU × Lead Time × Lead Time Factor</li>
          <li class="subformula">Red Safety = Red Base × Variability Factor</li>
          <li class="subformula">Top of Red (Safety Stock) = Red</li>

        </ul>
      </details>

      <div class="mt-5">
        <button id="resetBtn" class="rounded-xl bg-gray-100 px-4 py-2 font-medium text-gray-800 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-500">Reset</button>
      </div>
    </section>

    <section class="bg-white rounded-2xl border border-gray-200 p-5">
      <h2 class="text-lg font-semibold mb-4">Results</h2>
      <div class="grid gap-6 md:grid-cols-2 items-start">
        <div id="results" class="grid gap-4"></div>
        <div class="flex justify-center"><div id="viz"></div></div>
      </div>
    </section>
  </main>

  <div id="tt" class="tooltip"></div>

  <script>
    // ---------- Helpers ----------
    const fmt = (n) => (n==null || isNaN(n)) ? '—' : Math.round(n).toLocaleString();
    const el  = (id) => document.getElementById(id);
    const INPUT_IDS = ['adu','dlt','varFactor','moq','orderCycle'];

    // Show precise values in math without messy trailing zeros
    const f2 = (n) => {
      if(n==null || isNaN(n)) return '—';
      const s = (+n).toFixed(2);
      return s.replace(/\.00$/,'').replace(/(\.\d*[1-9])0$/,'$1');
    };
    const multLine = (lhs, terms, result) => {
      const parts = terms.map(f2).join(' × ');
      return `<div class="calc-line">${lhs} = ${parts} = <span class="font-medium">${f2(result)}</span></div>`;
    };
    const addLine = (lhs, terms, result) => {
      const parts = terms.map(f2).join(' + ');
      return `<div class="calc-line">${lhs} = ${parts} = <span class="font-medium">${f2(result)}</span></div>`;
    };
    const maxLine = (lhs, options, chosen) => {
      const parts = options.map(o => f2(o)).join(', ');
      return `<div class="calc-line">${lhs} = max(${parts}) = <span class="font-medium">${f2(chosen)}</span></div>`;
    };

    function setVar(v){ const vf=el('varFactor'); if(vf){vf.value=v; renderResults(calculate());}}

    function readValues(){
      const vals={};
      INPUT_IDS.forEach(id=>{
        const node=el(id); const v=node?parseFloat(node.value):NaN;
        vals[id]=(isNaN(v)?null:v);
      });
      return vals;
    }

    function leadTimeFactor(dlt){
      if(dlt==null||isNaN(dlt))return null;
      if(dlt<=5)return 0.80;
      if(dlt<=10)return 0.50;
      if(dlt<=20)return 0.35;
      return 0.20;
    }

    function calculate(){
      const {adu,dlt,varFactor,moq,orderCycle}=readValues();
      if([adu,dlt,varFactor].some(v=>v==null||v<0))
        return {error:'Please fill in all required fields with valid numbers.'};
      if(varFactor>1)return {error:'Variability must be between 0 and 1.'};

      const ltf = leadTimeFactor(dlt);
      const yellow = adu * dlt;

      const redBase = adu * dlt * (ltf ?? 0);
      const redSafety = redBase * varFactor;
      const red = redBase + redSafety;

      const greenBase = adu * dlt * (ltf ?? 0);
      const hasMoq = (moq!=null && moq>0);
      const hasOrderCycle = (orderCycle!=null && orderCycle>0);
      const orderFloor = hasOrderCycle ? (adu * orderCycle) : null;

      let green = greenBase;
      if(hasMoq) green = Math.max(green, moq);
      if(hasOrderCycle) green = Math.max(green, orderFloor);

      const moqBinding = hasMoq && moq === green;
      const ocBinding = hasOrderCycle && orderFloor === green;

      const topRed = red;
      const topYellow = red + yellow;
      const topGreen = red + yellow + green;

      return {
        adu,dlt,varFactor,moq,orderCycle,ltf,
        yellow,redBase,redSafety,red,
        greenBase,green,moqBinding,ocBinding,orderFloor,
        topRed,topYellow,topGreen
      };
    }

    // Build the expandable details content for each card
    function buildDetails(res){
      const { adu, dlt, ltf, varFactor, moq, orderCycle,
              yellow, redBase, redSafety, red,
              greenBase, green, moqBinding, ocBinding, orderFloor,
              topRed, topYellow, topGreen } = res;

      // YELLOW math
      const yellowMath = [
        multLine('Yellow', [adu, dlt], yellow),
        addLine('Top of Yellow', [red, yellow], topYellow)
      ].join('');

      // RED math
      const redMath = [
        multLine('Red Base', [adu, dlt, ltf??0], redBase),
        multLine('Red Safety', [redBase, varFactor], redSafety),
        addLine('Red', [redBase, redSafety], red),
        `<div class="calc-line">Top of Red = Red = <span class="font-medium">${f2(topRed)}</span></div>`
      ].join('');

      // GREEN math + binding narrative
      const greenPieces = [];
      greenPieces.push(multLine('Green Base', [adu, dlt, ltf??0], greenBase));
      const options = [greenBase];
      if(moq!=null && moq>0) options.push(moq);
      if(orderCycle!=null && orderCycle>0) options.push(orderFloor);

      if(options.length>1){
        greenPieces.push(maxLine('Green', options, green));
        if(moqBinding){
          greenPieces.push(`<div class="text-xs text-amber-700 mt-1">Bound by MOQ (${f2(moq)}).</div>`);
        }else if(ocBinding){
          greenPieces.push(`<div class="text-xs text-amber-700 mt-1">Bound by Order Frequency (ADU × ${f2(orderCycle)} = ${f2(orderFloor)}).</div>`);
        }
      }else{
        greenPieces.push(`<div class="calc-line">Green = <span class="font-medium">${f2(green)}</span></div>`);
      }
      greenPieces.push(addLine('Top of Green', [red, yellow, green], topGreen));
      const greenMath = greenPieces.join('');

      return { yellowMath, redMath, greenMath };
    }

    function renderResults(res){
      const container=el('results');
      if(!container)return;
      container.innerHTML='';
      if(res.error){container.innerHTML=`<div class='text-red-600'>${res.error}</div>`;return;}

      el('ltFactorDisplay').textContent=(res.ltf==null?'—':res.ltf.toFixed(2));

      let greenSub = `Green from Base (=${fmt(res.greenBase)})`;
      if(res.moqBinding) greenSub = `Green floored by MOQ ${fmt(res.moq)} (Base = ${fmt(res.greenBase)})`;
      else if(res.ocBinding) greenSub = `Green floored by Order Freq ${fmt(res.orderFloor)} (ADU × ${res.orderCycle})`;

      const { greenMath, yellowMath, redMath } = buildDetails(res);

      const cards=[
        {
          id:'card-green',
          label:'Top of Green (Replenishment Target)',
          value:res.topGreen,
          sub:greenSub,
          detailsHtml: greenMath,
          accent:'text-green-600'
        },
        {
          id:'card-yellow',
          label:'Top of Yellow (Replenishment Trigger)',
          value:res.topYellow,
          detailsHtml: yellowMath,
          accent:'text-yellow-600'
        },
        {
          id:'card-red',
          label:'Top of Red (Safety Stock)',
          value:res.topRed,
          sub:`Red = Red Base ${fmt(res.redBase)} + Red Safety ${fmt(res.redSafety)}`,
          detailsHtml: redMath,
          accent:'text-red-600'
        }
      ];

      cards.forEach(c=>{
        const card=document.createElement('div');
        card.className='rounded-xl border border-gray-200 p-4';
        card.innerHTML=`
          <div class='flex items-start justify-between gap-3'>
            <div>
              <div class='text-sm text-gray-500'>${c.label}</div>
              <div class='mt-1 text-2xl font-semibold ${c.accent??''}'>${fmt(c.value)}</div>
              ${c.sub?`<div class='mt-1 text-xs ${res.moqBinding||res.ocBinding?'text-amber-700':'text-gray-500'}'>${c.sub}</div>`:''}
            </div>
            <button class="mt-1 inline-flex items-center gap-2 text-sm text-gray-600 hover:text-gray-900"
                    data-toggle="${c.id}">
              <svg class="chev h-4 w-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 111.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
              </svg>
              <span>Show math</span>
            </button>
          </div>
          <div id="${c.id}" class="mt-3 hidden rounded-lg bg-gray-50 border border-gray-200 p-3 text-sm leading-6 space-y-1">
            ${c.detailsHtml}
          </div>`;
        container.appendChild(card);
      });

      // wire up toggles
      container.querySelectorAll('[data-toggle]').forEach(btn=>{
        const targetId = btn.getAttribute('data-toggle');
        const target = el(targetId);
        const icon = btn.querySelector('.chev');
        const label = btn.querySelector('span');
        btn.addEventListener('click', ()=>{
          const open = target.classList.toggle('hidden') === false;
          if(open){ icon.classList.add('open'); label.textContent='Hide math'; }
          else { icon.classList.remove('open'); label.textContent='Show math'; }
        });
      });

      renderViz(res);
    }

    function renderViz({red,yellow,green}){
      const viz=el('viz'); if(!viz)return;
      const total=(+red + +yellow + +green) || 1;

      viz.innerHTML=`
        <div class="relative h-72 w-20 border border-gray-300 rounded-lg overflow-hidden flex flex-col-reverse">
          <div id="seg-red" style="height:${(red/total*100)}%;background:#ef4444"></div>
          <div id="seg-yellow" style="height:${(yellow/total*100)}%;background:#f59e0b"></div>
          <div id="seg-green" style="height:${(green/total*100)}%;background:#22c55e"></div>
        </div>`;

      const tt = el('tt');
      const attach = ({id,label,value})=>{
        const n = document.getElementById(id);
        if(!n) return;
        const show = e => { tt.style.display='block'; tt.textContent = `${label}: ${fmt(value)}`; move(e); };
        const hide = () => { tt.style.display='none'; };
        const move = e => { tt.style.left = e.clientX+'px'; tt.style.top = e.clientY+'px'; };

        n.addEventListener('mouseenter', show);
        n.addEventListener('mousemove', move);
        n.addEventListener('mouseleave', hide);

        n.addEventListener('touchstart', (e)=>show(e.touches[0]), {passive:true});
        n.addEventListener('touchmove',  (e)=>move(e.touches[0]), {passive:true});
        n.addEventListener('touchend', hide);
        n.addEventListener('touchcancel', hide);
      };

      attach({id:'seg-red',    label:'Red',    value:red});
      attach({id:'seg-yellow', label:'Yellow', value:yellow});
      attach({id:'seg-green',  label:'Green',  value:green});
    }

    // Reset & live update
    el('resetBtn').addEventListener('click',()=>{
      ['adu','dlt','varFactor','moq','orderCycle'].forEach(id=>el(id).value='');
      el('results').innerHTML=''; el('viz').innerHTML='';
      el('ltFactorDisplay').textContent='—';
    });
    ['adu','dlt','varFactor','moq','orderCycle'].forEach(id=>{
      const node=el(id);
      if(node) node.addEventListener('input',()=>renderResults(calculate()));
    });

    // Initial render
    renderResults(calculate());
  </script>
</body>
</html>
