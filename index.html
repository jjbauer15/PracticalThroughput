<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DDMRP Buffer Calculator — with Zone Tooltips</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { color-scheme: light dark; }
    .number-input { appearance: textfield; background-color: #f8f9fa; }
    .number-input::-webkit-outer-spin-button,
    .number-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .calc-line { font-variant-numeric: tabular-nums; }

    /* Tooltip bubble */
    .tooltip {
      position: fixed;
      pointer-events: none;
      z-index: 1000;
      background: #111827;          /* gray-900 */
      color: #fff;
      font-size: .75rem;             /* text-xs */
      line-height: 1rem;
      padding: .35rem .5rem;
      border-radius: .375rem;        /* rounded-md */
      box-shadow: 0 8px 24px rgba(0,0,0,.18);
      opacity: 0;
      transform: translate(-50%, -120%);
      transition: opacity .08s ease;
      white-space: nowrap;
    }
    .tooltip[data-show="true"] { opacity: 1; }
  </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-900 antialiased">
  <header class="bg-white border-b border-gray-200">
    <div class="mx-auto max-w-5xl px-4 py-6 flex items-center justify-between">
      <h1 class="text-2xl font-semibold">DDMRP Buffer Calculator</h1>
    </div>
  </header>

  <main class="mx-auto max-w-5xl px-4 py-6 grid gap-6">
    <!-- INPUTS -->
    <section class="bg-white rounded-2xl border border-gray-200 p-5">
      <h2 class="text-lg font-semibold mb-4">Inputs</h2>

      <div class="grid gap-4 sm:grid-cols-2">
        <label class="block">
          <span class="text-sm text-gray-600">Average Daily Usage (ADU)*</span>
          <input id="adu" type="number" step="any" value="25"
                 class="number-input mt-1 w-full rounded-xl border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-indigo-500"/>
        </label>

        <label class="block">
          <span class="text-sm text-gray-600">Supplier Lead Time (days)*</span>
          <input id="dlt" type="number" step="any" value="10"
                 class="number-input mt-1 w-full rounded-xl border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-indigo-500"/>
        </label>

        <div class="sm:col-span-2 grid sm:grid-cols-2 gap-4">
          <label class="block">
            <span class="text-sm text-gray-600">Variability Factor (0–1)*</span>
            <input id="varFactor" type="number" min="0" max="1" step="0.05" value="0.30"
                   class="number-input mt-1 w-full rounded-xl border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-indigo-500"/>
            <div class="mt-2 flex flex-wrap gap-2 text-xs">
              <button type="button" class="rounded-full border px-3 py-1 hover:bg-gray-50" onclick="setVar(0.15)">Low 0.15</button>
              <button type="button" class="rounded-full border px-3 py-1 hover:bg-gray-50" onclick="setVar(0.30)">Med 0.30</button>
              <button type="button" class="rounded-full border px-3 py-1 hover:bg-gray-50" onclick="setVar(0.50)">High 0.50</button>
              <button type="button" class="rounded-full border px-3 py-1 hover:bg-gray-50" onclick="setVar(0.70)">V-High 0.70</button>
            </div>
          </label>

          <div class="flex flex-col justify-end">
            <div class="text-sm text-gray-600">Lead Time Factor (auto)</div>
            <div id="ltFactorDisplay" class="text-2xl font-semibold">—</div>
            <div class="text-xs text-gray-500 mt-1">Derived from supplier lead time.</div>
          </div>
        </div>
      </div>

      <details class="mt-6 rounded-xl border border-gray-200 open:bg-gray-50">
        <summary class="cursor-pointer font-semibold px-3 py-2">Optional Inputs</summary>
        <div class="px-3 pb-4 pt-2 grid gap-4 sm:grid-cols-2">
          <label class="block">
            <span class="text-sm text-gray-600">Minimum Order Quantity (MOQ)</span>
            <input id="moq" type="number" step="any"
                   class="number-input mt-1 w-full rounded-xl border border-gray-300 px-3 py-2"/>
          </label>

          <label class="block">
            <span class="text-sm text-gray-600">Imposed Order Frequency (days)</span>
            <input id="orderCycle" type="number" step="any"
                   class="number-input mt-1 w-full rounded-xl border border-gray-300 px-3 py-2"/>
          </label>
        </div>
      </details>

      <details class="mt-4 rounded-xl border border-gray-200 open:bg-gray-50">
        <summary class="cursor-pointer font-semibold px-3 py-2">Current Supply (optional)</summary>
        <div class="px-3 pb-4 pt-2 grid gap-4 sm:grid-cols-3">
          <label><span class="text-sm text-gray-600">On-order</span>
            <input id="onOrder" type="number" step="any"
                   class="number-input mt-1 w-full rounded-xl border border-gray-300 px-3 py-2"/>
          </label>
          <label><span class="text-sm text-gray-600">On-hand</span>
            <input id="onHand" type="number" step="any"
                   class="number-input mt-1 w-full rounded-xl border border-gray-300 px-3 py-2"/>
          </label>
          <label><span class="text-sm text-gray-600">Committed</span>
            <input id="committed" type="number" step="any"
                   class="number-input mt-1 w-full rounded-xl border border-gray-300 px-3 py-2"/>
          </label>
        </div>
      </details>

      <div class="mt-5">
        <button id="resetBtn"
                class="rounded-xl bg-gray-100 px-4 py-2 font-medium text-gray-800 hover:bg-gray-200 focus:ring-2 focus:ring-indigo-500">
          Reset
        </button>
      </div>
    </section>

    <!-- RESULTS -->
    <section class="bg-white rounded-2xl border border-gray-200 p-5">
      <h2 class="text-lg font-semibold mb-4">Results</h2>
      <div class="grid md:grid-cols-2 gap-6">
        <!-- Zone cards + math -->
        <div id="results" class="grid gap-4"></div>

        <!-- Viz + NF + Message -->
        <div class="flex flex-col gap-3">
          <div class="flex items-start gap-4">
            <div class="relative">
              <div id="viz"></div>
            </div>
            <div>
              <div id="nfCard" class="rounded-xl border border-gray-200 p-4 w-56 transition-colors duration-300">
                <div class="text-sm text-gray-700 font-medium">Net Flow Position</div>
                <div id="nfValue" class="mt-1 text-2xl font-semibold text-gray-900">—</div>
                <div id="nfDetail" class="mt-1 text-xs text-gray-700"></div>
              </div>
              <div id="nfMessage" class="mt-3 rounded-xl border border-gray-200 p-3 text-sm bg-gray-50 text-gray-800" style="display:none"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- NOTES -->
    <details class="rounded-2xl border border-gray-200 p-3 open:bg-gray-50">
      <summary class="cursor-pointer font-medium">Formula notes</summary>
      <ul class="mt-2 text-sm text-gray-700 space-y-2">
        <li><strong class="text-green-600">Green</strong>: ADU × LT × LTF (bounded by MOQ / order freq)</li>
        <li><strong class="text-yellow-600">Yellow</strong>: ADU × LT</li>
        <li><strong class="text-red-600">Red</strong>: (ADU × LT × LTF) + (RedBase × VarFactor)</li>
        <li>Net Flow = On-hand + On-order − Committed</li>
      </ul>
    </details>
  </main>

  <!-- Single tooltip node -->
  <div id="tooltip" class="tooltip" role="tooltip" aria-hidden="true"></div>

  <script>
    // --------- Helpers ---------
    const el  = id => document.getElementById(id);
    const fmt = n => isNaN(n) ? '—' : Math.round(n).toLocaleString();
    const num = n => Number.isFinite(n) ? (+n).toLocaleString(undefined, {maximumFractionDigits: 2}) : '—';
    const INPUTS = ['adu','dlt','varFactor','moq','orderCycle','onOrder','onHand','committed'];

    // Lead Time Factor schedule (simple heuristic)
    const leadTimeFactor = dlt => dlt<=5?0.8:dlt<=10?0.5:dlt<=20?0.35:0.2;

    const setVar = v => { el('varFactor').value = v; renderResults(calc()); };

    function calc(){
      const v = {}; INPUTS.forEach(i => v[i] = parseFloat(el(i).value));

      // Detect whether the user actually typed anything into Current Supply
      const onOrderStr   = el('onOrder').value ?? '';
      const onHandStr    = el('onHand').value ?? '';
      const committedStr = el('committed').value ?? '';
      const hasSupplyInputs = [onOrderStr, onHandStr, committedStr].some(s => String(s).trim() !== '');

      const adu        = Number.isFinite(v.adu) ? v.adu : 0;
      const dlt        = Number.isFinite(v.dlt) ? v.dlt : 0;
      const varFactor  = Number.isFinite(v.varFactor) ? v.varFactor : 0;
      const moq        = Number.isFinite(v.moq) ? v.moq : 0;
      const orderCycle = Number.isFinite(v.orderCycle) ? v.orderCycle : 0;
      const onOrder    = Number.isFinite(v.onOrder) ? v.onOrder : 0;
      const onHand     = Number.isFinite(v.onHand) ? v.onHand : 0;
      const committed  = Number.isFinite(v.committed) ? v.committed : 0;

      if(!adu || !dlt) return { error:'Missing required inputs', adu,dlt };

      const ltf    = leadTimeFactor(dlt);
      const yellow = adu * dlt;

      const redBase   = adu * dlt * ltf;
      const redSafety = redBase * varFactor;
      const red       = redBase + redSafety;

      // Green bounded by MOQ and Order Frequency (ADU * orderCycle)
      const greenBase  = adu * dlt * ltf;
      const greenMoq   = moq > 0 ? moq : -Infinity;
      const greenCycle = orderCycle > 0 ? adu * orderCycle : -Infinity;
      const green      = Math.max(greenBase, greenMoq, greenCycle, 0);

      const moqBinding = green === greenMoq;
      const ocBinding  = green === greenCycle;
      const greenBound = moqBinding ? 'MOQ' : ocBinding ? 'Order Frequency' : 'Green Base';

      const topRed    = red;
      const topYellow = red + yellow;
      const topGreen  = red + yellow + green;

      const netFlow   = onHand + onOrder - committed;

      return {
        adu,dlt,varFactor,ltf,
        yellow,
        redBase,redSafety,red,
        greenBase, green, greenMoq, greenCycle, greenBound, moqBinding, ocBinding,
        topRed,topYellow,topGreen,
        onOrder,onHand,committed,netFlow,
        hasSupplyInputs
      };
    }

    function renderResults(res){
      const container = el('results');
      if (res.error){
        container.innerHTML = `<div class='text-red-600'>${res.error}. Enter ADU and Lead Time.</div>`;
        el('ltFactorDisplay').textContent = '—';
        el('viz').innerHTML = '';
        el('nfValue').textContent = '—';
        el('nfDetail').textContent = '';
        el('nfCard').style.background = '#f3f4f6';
        const box = el('nfMessage'); box.innerHTML = ''; box.style.display = 'none';
        return;
      }
      el('ltFactorDisplay').textContent = res.ltf.toFixed(2);

      // Build details HTML for each card
      const redDetails = `
        <div class="calc-line"><span class="font-medium">Red Base</span> = ADU × LT × LTF = ${num(res.adu)} × ${num(res.dlt)} × ${num(res.ltf)} = <span class="font-medium">${num(res.redBase)}</span></div>
        <div class="calc-line"><span class="font-medium">Red Safety</span> = Red Base × Var = ${num(res.redBase)} × ${num(res.varFactor)} = <span class="font-medium">${num(res.redSafety)}</span></div>
        <div class="calc-line"><span class="font-medium">Total Red</span> = Red Base + Red Safety = ${num(res.redBase)} + ${num(res.redSafety)} = <span class="font-medium">${num(res.red)}</span></div>
      `;

      const yellowDetails = `
        <div class="calc-line"><span class="font-medium">Yellow</span> = ADU × LT = ${num(res.adu)} × ${num(res.dlt)} = <span class="font-medium">${num(res.yellow)}</span></div>
        <div class="calc-line"><span class="font-medium">Cumulative</span> = Red + Yellow = ${num(res.red)} + ${num(res.yellow)} = <span class="font-medium">${num(res.topYellow)}</span></div>
      `;

      const greenDetails = `
        <div class="calc-line"><span class="font-medium">Green Base</span> = ADU × LT × LTF = ${num(res.adu)} × ${num(res.dlt)} × ${num(res.ltf)} = <span class="font-medium">${num(res.greenBase)}</span></div>
        ${Number.isFinite(res.greenMoq) && res.greenMoq !== -Infinity ? `<div class="calc-line"><span class="font-medium">MOQ bound</span> = ${num(res.greenMoq)}</div>` : ''}
        ${Number.isFinite(res.greenCycle) && res.greenCycle !== -Infinity ? `<div class="calc-line"><span class="font-medium">Order Freq bound</span> = ADU × OrderCycle = ${num(res.adu)} × ${num(el('orderCycle').value || 0)} = <span class="font-medium">${num(res.greenCycle)}</span></div>` : ''}
        <div class="calc-line"><span class="font-medium">Chosen Green</span> = max(Green Base${res.greenMoq!==-Infinity?', MOQ':''}${res.greenCycle!==-Infinity?', Order Freq':''}) = <span class="font-medium">${num(res.green)}</span> <span class="text-xs text-gray-500">(${res.greenBound})</span></div>
        <div class="calc-line"><span class="font-medium">Cumulative</span> = Red + Yellow + Green = ${num(res.red)} + ${num(res.yellow)} + ${num(res.green)} = <span class="font-medium">${num(res.topGreen)}</span></div>
      `;

      const cards = [
        { id:'card-green',  label:'Top of Green',  value:res.topGreen,  accent:'text-green-600',  sub:`Chosen Green = ${fmt(res.green)} (${res.greenBound})`, detailsHtml:greenDetails },
        { id:'card-yellow', label:'Top of Yellow', value:res.topYellow, accent:'text-yellow-600', sub:`Yellow = ${fmt(res.yellow)}; Red + Yellow = ${fmt(res.red)} + ${fmt(res.yellow)}`, detailsHtml:yellowDetails },
        { id:'card-red',    label:'Top of Red',    value:res.topRed,    accent:'text-red-600',    sub:`Total Red = ${fmt(res.redBase)} + ${fmt(res.redSafety)}`, detailsHtml:redDetails },
      ];

      // Render cards
      container.innerHTML = '';
      cards.forEach(c=>{
        const card=document.createElement('div');
        card.className='rounded-xl border border-gray-200 p-4';
        card.innerHTML=`
          <div class='flex items-start justify-between gap-3'>
            <div>
              <div class='text-sm text-gray-500'>${c.label}</div>
              <div class='mt-1 text-2xl font-semibold ${c.accent??''}'>${fmt(c.value)}</div>
              ${c.sub?`<div class='mt-1 text-xs text-gray-500'>${c.sub}</div>`:''}
            </div>
            <button class="mt-1 inline-flex items-center gap-2 text-sm text-gray-600 hover:text-gray-900"
                    data-toggle="${c.id}">
              <svg class="chev h-4 w-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 111.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
              </svg>
              <span>Show math</span>
            </button>
          </div>
          <div id="${c.id}" class="mt-3 hidden rounded-lg bg-gray-50 border border-gray-200 p-3 text-sm leading-6 space-y-1">
            ${c.detailsHtml}
          </div>`;
        container.appendChild(card);
      });

      // toggles
      container.querySelectorAll('[data-toggle]').forEach(btn=>{
        const targetId = btn.getAttribute('data-toggle');
        const target = el(targetId);
        const icon = btn.querySelector('.chev');
        const label = btn.querySelector('span');
        btn.addEventListener('click', ()=>{
          const nowHidden = target.classList.toggle('hidden');
          const open = !nowHidden;
          if(open){ icon.style.transform='rotate(90deg)'; label.textContent='Hide math'; }
          else { icon.style.transform=''; label.textContent='Show math'; }
        });
      });

      // NF card + viz + advisor
      el('nfValue').textContent = fmt(res.netFlow);
      el('nfDetail').textContent = `On-hand ${fmt(res.onHand)}, On-order ${fmt(res.onOrder)}, Committed ${fmt(res.committed)}`;
      renderViz(res);
      colorNFCard(res);
      renderAdvisor(res);
    }

    function colorNFCard({netFlow,topRed,topYellow,topGreen}){
      const c = el('nfCard');
      c.style.background =
        !Number.isFinite(netFlow) || netFlow <= 0 ? '#f3f4f6' :
        netFlow <= topRed    ? '#fecaca' :         // red
        netFlow <= topYellow ? '#fde68a' :         // yellow
        netFlow <= topGreen  ? '#bbf7d0' :         // green
                               '#93c5fd';          // blue
    }

    // ---- Graph with tooltips on Red/Yellow/Green (NOT Blue) ----
    function renderViz({red, yellow, green, onHand, netFlow}){
      const v = el('viz');
      const topOfGreen = red + yellow + green;
      const overflowNF = Math.max(0, netFlow - topOfGreen);
      const headroom   = overflowNF > 0 ? overflowNF * 0.10 : 0;  // +10% when in blue
      const total      = Math.max(1, topOfGreen + overflowNF + headroom);

      const pBlue   = ((overflowNF + headroom) / total) * 100;
      const pGreen  = (green / total) * 100;
      const pYellow = (yellow / total) * 100;
      const pRed    = (red / total) * 100;

      const nfPct = (netFlow / total) * 100;
      const ohPct = (onHand  / total) * 100;

      // Build segment div helper with tooltip data
      const seg = (hPct, color, tipText, enableTooltip=true) => {
        if (hPct <= 0) return '';
        const tooltipAttr = enableTooltip ? `data-tooltip="${tipText}"` : '';
        return `<div class="zone-seg" ${tooltipAttr}
                     style="height:${hPct}%;background:${color};"></div>`;
      };

      const tipRed    = `Red: ${fmt(red)}`;
      const tipYellow = `Yellow: ${fmt(yellow)}`;
      const tipGreen  = `Green: ${fmt(green)}`;

      v.innerHTML = `
        <div class="relative h-72 w-28 sm:w-32 border border-gray-300 rounded-lg overflow-hidden flex flex-col">
          ${pBlue   > 0 ? seg(pBlue,   '#93c5fd', '', false) : ''}   <!-- Blue: NO tooltip -->
          ${pGreen  > 0 ? seg(pGreen,  '#22c55e', tipGreen,  true) : ''}
          ${pYellow > 0 ? seg(pYellow, '#f59e0b', tipYellow, true) : ''}
          ${pRed    > 0 ? seg(pRed,    '#ef4444', tipRed,    true) : ''}

          ${Number.isFinite(netFlow) ? `
            <div class="absolute left-0 right-0" style="top:${Math.max(0, 100 - nfPct)}%">
              <div class="h-0.5 bg-black"></div>
              <div class="absolute left-full -translate-y-1/2 ml-1 bg-white text-xs px-1.5 py-0.5 rounded border">${fmt(netFlow)}</div>
            </div>` : ''}

          ${Number.isFinite(onHand) ? `
            <div class="absolute left-0 right-0" style="top:${Math.max(0, 100 - ohPct)}%">
              <div class="border-t border-dashed border-black/70"></div>
              <div class="absolute left-full -translate-y-1/2 ml-1 bg-white text-xs px-1.5 py-0.5 rounded border">${fmt(onHand)}</div>
            </div>` : ''}
        </div>`;
      
      // Wire up tooltips for these newly-rendered segments
      attachZoneTooltips();
    }

    // Advisory logic under Net Flow
    function renderAdvisor({netFlow, topRed, topYellow, topGreen, adu, hasSupplyInputs}){
      const box = el('nfMessage');

      // Hide if no Current Supply values were entered
      if (!hasSupplyInputs) {
        box.style.display = 'none';
        box.innerHTML = '';
        return;
      }

      // Make sure the box is visible if we have supply inputs
      box.style.display = 'block';

      if (!adu || !Number.isFinite(netFlow)) {
        box.style.display = 'none';
        box.innerHTML = '';
        return;
      }

      let html = '', tone = '', bg = '';

      if (netFlow > topGreen) {
        const days = Math.ceil((netFlow - topYellow) / adu);
        const dayLabel = days === 1 ? 'day' : 'days';
        tone = 'text-blue-800'; bg = 'bg-blue-50/60 border-blue-200';
        html = `<div class="font-semibold ${tone}">Overstocked</div>
                <div class="mt-1">Estimated <span class="font-medium">${num(days)}</span> ${dayLabel} until next reorder.<br>(Net Flow − Top of Yellow) ÷ ADU</div>`;
      } else if (netFlow > topYellow) {
        const days = Math.ceil((netFlow - topYellow) / adu);
        const dayLabel = days === 1 ? 'day' : 'days';
        tone = 'text-green-800'; bg = 'bg-green-50/60 border-green-200';
        html = `<div class="font-semibold ${tone}">Properly stocked</div>
                <div class="mt-1">Estimated <span class="font-medium">${num(days)}</span> ${dayLabel} until next reorder.<br>(Net Flow − Top of Yellow) ÷ ADU</div>`;
      } else if (netFlow > topRed) {
        const po = Math.max(0, topGreen - netFlow);
        tone = 'text-yellow-900'; bg = 'bg-yellow-50/60 border-yellow-200';
        html = `<div class="font-semibold ${tone}">Understocked</div>
                <div class="mt-1">PO amount: <span class="font-medium">${fmt(po)}</span><br>Top of Green − Net Flow</div>`;
      } else {
        const po = Math.max(0, topGreen - netFlow);
        tone = 'text-red-900'; bg = 'bg-red-50/60 border-red-200';
        html = `<div class="font-semibold ${tone}">Very high priority</div>
                <div class="mt-1">Place a PO for <span class="font-medium">${fmt(po)}</span><br>(Top of Green − Net Flow) <span class="font-medium"><br>Stockout risk</span> until replenished</div>`;
      }

      box.className = `mt-3 rounded-xl border p-3 text-sm ${bg}`;
      box.innerHTML = html;
    }

    // -------- Tooltip wiring (works on dynamically rendered segments) --------
    function attachZoneTooltips(){
      const tooltip = el('tooltip');
      const zones = document.querySelectorAll('.zone-seg[data-tooltip]');
      zones.forEach(z => {
        z.addEventListener('pointerenter', e => {
          const text = z.getAttribute('data-tooltip') || '';
          if(!text){ tooltip.dataset.show = 'false'; return; }
          tooltip.textContent = text;
          tooltip.dataset.show = 'true';
          tooltip.setAttribute('aria-hidden', 'false');
        });
        z.addEventListener('pointermove', e => {
          // position near cursor, keep in viewport
          const pad = 10;
          let x = e.clientX;
          let y = e.clientY - 12;
          const rect = tooltip.getBoundingClientRect();
          const vw = window.innerWidth, vh = window.innerHeight;
          if (x + rect.width/2 + pad > vw) x = vw - rect.width/2 - pad;
          if (x - rect.width/2 - pad < 0)  x = rect.width/2 + pad;
          if (y - rect.height - pad < 0)   y = rect.height + pad + 12;
          tooltip.style.left = x + 'px';
          tooltip.style.top  = y + 'px';
        });
        z.addEventListener('pointerleave', () => {
          tooltip.dataset.show = 'false';
          tooltip.setAttribute('aria-hidden', 'true');
        });
      });
    }

    // Reset & listeners
    el('resetBtn').onclick = () => {
      INPUTS.forEach(i => el(i).value = '');
      el('results').innerHTML = '';
      el('viz').innerHTML = '';
      el('nfCard').style.background = '#f3f4f6';
      el('nfValue').textContent = '—';
      el('nfDetail').textContent = '';
      el('ltFactorDisplay').textContent = '—';
      el('nfMessage').innerHTML = '';
      el('nfMessage').style.display = 'none';
    };
    INPUTS.forEach(i => el(i).addEventListener('input', () => renderResults(calc())));

    // initial render
    renderResults(calc());
  </script>
</body>
</html>
